<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Sky Magic Dogfight</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
}
body{
  margin:0;
  background:#020312;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  text-align:center;
  height:100vh;
  overflow:hidden;
  overscroll-behavior:none;
  touch-action:none;
}
h2{margin:10px 0 0;}
#ui{font-size:13px;opacity:.9;margin-bottom:4px;}

canvas{
  background:#050818;
  box-shadow:0 0 24px #000;
  border:2px solid #1f2937;
  margin:6px auto;
  display:block;
  touch-action:none;
}

/* ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
#menuOverlay,#resultOverlay,#localOverlay{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
#menuOverlay{
  background:
    radial-gradient(circle at top, rgba(59,130,246,0.22), rgba(15,23,42,0.98));
  overflow:hidden;
}
#menuOverlay::before{
  content:"";
  position:absolute;
  inset:-40px;
  background:
    radial-gradient(circle at 20% 10%, rgba(56,189,248,0.25), transparent 55%),
    radial-gradient(circle at 80% 80%, rgba(236,72,153,0.28), transparent 55%),
    radial-gradient(circle at 10% 80%, rgba(52,211,153,0.26), transparent 60%);
  opacity:0.7;
  mix-blend-mode:screen;
  animation:menuGlow 10s ease-in-out infinite alternate;
  pointer-events:none;
}

#resultOverlay,#localOverlay{
  background:rgba(0,0,0,.85);
  display:none;
  z-index:11;
}
@keyframes menuGlow{
  0%{transform:scale(1);}
  100%{transform:scale(1.05) translateY(-8px);}
}

/* ===== å…±é€šãƒœãƒƒã‚¯ã‚¹ ===== */
.box{
  position:relative;
  background:#020617ee;
  border:1px solid #374151;
  padding:16px;
  border-radius:14px;
  max-width:560px;
  width:92%;
  font-size:13px;
  box-shadow:
    0 0 25px rgba(15,23,42,0.9),
    0 0 60px rgba(59,130,246,0.35);
  overflow:hidden;
}
.box::before{
  content:"";
  position:absolute;
  width:260px;
  height:260px;
  border-radius:50%;
  border:1px dashed rgba(129,140,248,0.55);
  top:-130px;
  right:-60px;
  animation:spinCircle 18s linear infinite;
  opacity:0.8;
  pointer-events:none;
}
.box::after{
  content:"";
  position:absolute;
  width:140px;
  height:140px;
  border-radius:50%;
  border:1px solid rgba(248,250,252,0.2);
  bottom:-60px;
  left:-40px;
  animation:spinCircleReverse 26s linear infinite;
  opacity:0.45;
  pointer-events:none;
}
@keyframes spinCircle{
  from{transform:rotate(0deg);}
  to{transform:rotate(360deg);}
}
@keyframes spinCircleReverse{
  from{transform:rotate(360deg);}
  to{transform:rotate(0deg);}
}

/* ===== ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­— ===== */
#menuTitle{
  font-size:24px;
  letter-spacing:1px;
  background:linear-gradient(120deg,#a5b4fc,#f97316,#22c55e,#a5b4fc);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  text-shadow:
    0 0 10px rgba(129,140,248,0.8),
    0 0 22px rgba(56,189,248,0.7);
}
#pageTitle{
  text-shadow:0 0 10px rgba(56,189,248,0.7);
}

.row{text-align:left;margin:6px 0;}
input{
  width:100%;
  border:1px solid #4b5563;
  border-radius:8px;
  background:#020617;
  color:#e5e7eb;
  padding:6px;
}
.books{
  display:flex;
  gap:6px;
}
.book{
  flex:1;
  border-radius:10px;
  border:1px solid #4b5563;
  padding:8px;
  background:#020617cc;
  cursor:pointer;
  position:relative;
  overflow:hidden;
}
.book::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:radial-gradient(circle at 10% 0%,rgba(251,191,36,0.2),transparent 55%);
  opacity:0;
  transition:opacity .3s;
  pointer-events:none;
}
.book.active::before{
  opacity:1;
}
.book.active{
  outline:2px solid #60a5fa;
  background:#0b1029;
}
.btn{
  padding:8px 18px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-weight:700;
  margin:4px 3px 0;
}
.btn.green{background:#22c55e;color:#022c22;}
.btn.blue{background:#3b82f6;color:#f9fafb;}
.btn.gray{background:#4b5563;color:#e5e7eb;}
.btn.orange{background:#f97316;color:#111827;}

.langRow{display:flex;justify-content:space-between;align-items:center;}
.langBtns{display:flex;gap:4px;}
.langBtn{
  padding:3px 10px;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#020617;
  color:#e5e7eb;
  font-size:11px;
  cursor:pointer;
}
.langBtn.active{
  background:#2563eb;
  border-color:#60a5fa;
}
.modeBtns{display:flex;gap:4px;margin-top:2px;}
.modeBtn{
  padding:4px 10px;
  border-radius:999px;
  border:1px solid #4b5563;
  background:#020617;
  color:#e5e7eb;
  font-size:11px;
  cursor:pointer;
}
.modeBtn.active{
  background:#16a34a;
  border-color:#4ade80;
  color:#022c22;
}

table{
  border-collapse:collapse;
  width:100%;
  margin-top:6px;
  font-size:11px;
}
th,td{
  border-bottom:1px solid #374151;
  padding:4px 6px;
  text-align:left;
}
th{background:#1f2937;}
tr.you{color:#fb923c;font-weight:700;}

textarea{
  width:100%;
  min-height:60px;
  border-radius:8px;
  border:1px solid #4b5563;
  background:#020617;
  color:#e5e7eb;
  padding:6px;
  font-size:11px;
}

#hudLeft,#hudRight,#weeklyHUD,#respawnHUD{
  position:fixed;
  font-size:12px;
  white-space:pre;
  pointer-events:none;
}
#hudLeft{left:10px;top:10px;text-align:left;}
#hudRight{right:10px;top:10px;text-align:right;}
#weeklyHUD{left:10px;bottom:10px;font-size:11px;opacity:.85;}
#respawnHUD{left:0;right:0;bottom:16px;text-align:center;font-size:14px;}

/* ===== Mobile twin-stick controls ===== */
#mobileControls{
  position:fixed;
  inset:0;
  pointer-events:none;
  display:none;
  z-index:5;
  touch-action:none;
}
.stick{
  position:absolute;
  width:120px;
  height:120px;
  border-radius:50%;
  border:2px solid rgba(148,163,184,0.9);
  background:rgba(15,23,42,0.65);
  box-shadow:0 0 14px rgba(15,23,42,0.9);
  pointer-events:auto;
  touch-action:none;
}
.stickInner{
  position:absolute;
  width:54px;
  height:54px;
  border-radius:50%;
  background:rgba(248,250,252,0.14);
  border:1px solid rgba(248,250,252,0.7);
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
}
#leftStick{left:20px;bottom:30px;}
#rightStick{right:20px;bottom:30px;}

.btnUlt{
  position:absolute;
  right:24px;
  bottom:140px;
  width:72px;
  height:72px;
  border-radius:999px;
  border:none;
  background:radial-gradient(circle at 30% 30%, #facc15, #f97316);
  color:#111827;
  font-weight:700;
  font-size:14px;
  pointer-events:auto;
  box-shadow:0 0 18px rgba(250,204,21,0.8);
  touch-action:none;
}
.btnUlt.disabled{
  filter:grayscale(1);
  opacity:0.4;
  box-shadow:none;
}

/* æ¨ªç”»é¢ï¼šã‚¹ãƒ†ã‚£ãƒƒã‚¯1.5å€ */
body.landscape #mobileControls .stick{
  width:180px;
  height:180px;
}
body.landscape #mobileControls .stickInner{
  width:81px;
  height:81px;
}
body.landscape #leftStick{
  left:40px;
  bottom:40px;
}
body.landscape #rightStick{
  right:40px;
  bottom:40px;
}
body.landscape .btnUlt{
  right:40px;
  bottom:190px;
}

/* æ¨ªç”»é¢ã§ã¯ã‚¿ã‚¤ãƒˆãƒ«ç³»ã‚’éš ã™ */
body.landscape #pageTitle,
body.landscape #ui{
  display:none;
}
</style>
</head>
<body>

<!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="menuOverlay">
  <div class="box">
    <div class="langRow">
      <h2 id="menuTitle">Sky Magic Dogfight</h2>
      <div class="langBtns">
        <button id="langJa" class="langBtn active">æ—¥æœ¬èª</button>
        <button id="langEn" class="langBtn">English</button>
      </div>
    </div>

    <div class="row" id="labelName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</div>
    <input id="playerName" placeholder="Player">

    <div class="row" id="labelBook">é­”å°æ›¸ã‚’é¸æŠ</div>
    <div class="books">
      <div id="bookFire" class="book active">
        <div id="fireTitle">ğŸ”¥ ç«ã®é­”å°æ›¸</div>
        <div id="fireSub" style="font-size:11px;opacity:.8;">å¿…æ®º: ç‰¹å¤§ãƒ“ãƒ¼ãƒ </div>
      </div>
      <div id="bookWater" class="book">
        <div id="waterTitle">ğŸ’§ æ°´ã®é­”å°æ›¸</div>
        <div id="waterSub" style="font-size:11px;opacity:.8;">å¿…æ®º: ç„¡æ•µãƒãƒªã‚¢</div>
      </div>
    </div>

    <div class="row" id="labelMode">æ“ä½œãƒ¢ãƒ¼ãƒ‰</div>
    <div class="modeBtns">
      <button id="modePc" class="modeBtn active">PCç‰ˆ</button>
      <button id="modeMobile" class="modeBtn">ã‚¹ãƒãƒ›ç‰ˆ</button>
    </div>

    <div style="margin-top:6px;position:relative;z-index:1;">
      <button id="playBtn" class="btn green">ãƒ—ãƒ¬ã‚¤</button>
      <button id="openLocalBtn" class="btn gray">ãƒ­ãƒ¼ã‚«ãƒ«TOP10</button>
    </div>
    <div id="shareHint" style="margin-top:8px;font-size:11px;opacity:.8;position:relative;z-index:1;">
      ãƒ—ãƒ¬ã‚¤å¾Œã®ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã‹ã‚‰ã€çµæœã‚’Xãªã©ã«ã‚·ã‚§ã‚¢ã§ãã¾ã™ã€‚
    </div>
  </div>
</div>

<!-- ãƒªã‚¶ãƒ«ãƒˆ -->
<div id="resultOverlay">
  <div class="box">
    <h3 id="resultTitle">RESULT</h3>
    <div id="resultSummary"></div>
    <table>
      <thead>
        <tr><th>Rank</th><th>Name</th><th>K</th><th>Zone</th><th>Total</th></tr>
      </thead>
      <tbody id="resultTableBody"></tbody>
    </table>
    <div class="row" id="shareLabel">ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</div>
    <textarea id="shareText" readonly></textarea>
    <div style="margin-top:6px;">
      <button id="copyShareBtn" class="btn orange">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
      <button id="saveImageBtn" class="btn green">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
      <button id="backTitleBtn" class="btn blue">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
<div id="localOverlay">
  <div class="box">
    <h3 id="localTitle">LOCAL TOP10</h3>
    <table>
      <thead>
        <tr><th>Rank</th><th>Name</th><th>K</th><th>Zone</th><th>Total</th></tr>
      </thead>
      <tbody id="localTableBody"></tbody>
    </table>
    <button id="closeLocalBtn" class="btn blue">é–‰ã˜ã‚‹</button>
  </div>
</div>

<h2 id="pageTitle">Sky Magic Dogfight</h2>
<div id="ui">PC: WASDï¼‹ãƒã‚¦ã‚¹ / Mobile: ç”»é¢ä¸‹ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‹ULTãƒœã‚¿ãƒ³</div>

<div id="hudLeft"></div>
<div id="hudRight"></div>
<div id="weeklyHUD"></div>
<div id="respawnHUD"></div>

<canvas id="gameCanvas" width="900" height="600"></canvas>

<!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ -->
<div id="mobileControls">
  <div id="leftStick" class="stick">
    <div id="leftStickInner" class="stickInner"></div>
  </div>
  <div id="rightStick" class="stick">
    <div id="rightStickInner" class="stickInner"></div>
  </div>
  <button id="mobileUlt" class="btnUlt">ULT</button>
</div>

<!-- åŠ¹æœéŸ³ï¼ˆshoot.wav ã¯ä½¿ç”¨ã—ãªã„ï¼‰ -->
<audio id="seDeath" src="death.wav"></audio>
<audio id="seZone" src="zone.wav"></audio>
<audio id="seUltFire" src="ult_fire.wav"></audio>
<audio id="seUltWater" src="ult_water.wav"></audio>

<script>
function $(id){return document.getElementById(id);}

const canvas = $("gameCanvas");
const ctx = canvas.getContext("2d");

const menuOverlay = $("menuOverlay");
const resultOverlay = $("resultOverlay");
const localOverlay  = $("localOverlay");

const nameInput = $("playerName");
const fireBookBtn = $("bookFire");
const waterBookBtn = $("bookWater");
const playBtn = $("playBtn");
const openLocalBtn = $("openLocalBtn");
const closeLocalBtn = $("closeLocalBtn");
const backTitleBtn = $("backTitleBtn");
const saveImageBtn = $("saveImageBtn");
const copyShareBtn = $("copyShareBtn");

const modePcBtn = $("modePc");
const modeMobileBtn = $("modeMobile");

const resultSummary = $("resultSummary");
const resultTableBody = $("resultTableBody");
const shareText = $("shareText");
const localTableBody = $("localTableBody");

const hudLeft = $("hudLeft");
const hudRight = $("hudRight");
const weeklyHUD = $("weeklyHUD");
const respawnHUD = $("respawnHUD");

const langJaBtn = $("langJa");
const langEnBtn = $("langEn");

const mobileControls = $("mobileControls");
const leftStick = $("leftStick");
const rightStick = $("rightStick");
const leftStickInner = $("leftStickInner");
const rightStickInner = $("rightStickInner");
const mobileUltBtn = $("mobileUlt");

/* ===== ã‚µã‚¦ãƒ³ãƒ‰ ===== */
const seDeath     = $("seDeath");
const seZone      = $("seZone");
const seUltFire   = $("seUltFire");
const seUltWater  = $("seUltWater");

let audioUnlocked = false;
function unlockAudio(){
  if(audioUnlocked) return;
  const list = [seDeath,seZone,seUltFire,seUltWater];
  list.forEach(a=>{
    if(!a) return;
    a.play().then(()=>{
      a.pause();
      a.currentTime = 0;
    }).catch(()=>{});
  });
  audioUnlocked = true;
}
function playSE(base){
  if(!base || !audioUnlocked) return;
  try{ base.currentTime = 0; }catch(e){}
  base.play().catch(()=>{});
}

/* ===== ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ã‚§ã‚¤ã‚¯ & ãƒ’ãƒƒãƒˆã‚¹ãƒˆãƒƒãƒ— ===== */
let shakeTimer = 0;
let shakeIntensity = 0;
let hitStopTimer = 0;
function triggerShake(intensity,duration){
  shakeIntensity = Math.max(shakeIntensity,intensity);
  shakeTimer = Math.max(shakeTimer,duration);
}
function triggerHitStop(duration){
  hitStopTimer = Math.max(hitStopTimer,duration);
}

/* ===== ç”»é¢ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° ===== */
function resizeGame(){
  const paddingX = 40;
  const isLandscape = window.innerWidth > window.innerHeight;

  document.body.classList.toggle("landscape", isLandscape);
  document.body.classList.toggle("portrait", !isLandscape);

  const paddingY = isLandscape ? 80 : 200;
  const scaleX = window.innerWidth  / (canvas.width + paddingX);
  const scaleY = window.innerHeight / (canvas.height + paddingY);
  const scale = Math.min(scaleX, scaleY, 1);

  canvas.style.width  = (canvas.width  * scale) + "px";
  canvas.style.height = (canvas.height * scale) + "px";
}
window.addEventListener("resize", resizeGame);

/* ===== i18n ===== */
const i18n = {
  ja:{
    title:"Sky Magic Dogfight",
    ui:"PC: WASDï¼‹ãƒã‚¦ã‚¹ / Mobile: ç”»é¢ä¸‹ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‹ULTãƒœã‚¿ãƒ³",
    labelName:"ãƒ¦ãƒ¼ã‚¶ãƒ¼å",
    labelBook:"é­”å°æ›¸ã‚’é¸æŠ",
    labelMode:"æ“ä½œãƒ¢ãƒ¼ãƒ‰",
    modePc:"PCç‰ˆ",
    modeMobile:"ã‚¹ãƒãƒ›ç‰ˆ",
    fireTitle:"ğŸ”¥ ç«ã®é­”å°æ›¸",
    fireSub:"å¿…æ®º: ç‰¹å¤§ãƒ“ãƒ¼ãƒ ",
    waterTitle:"ğŸ’§ æ°´ã®é­”å°æ›¸",
    waterSub:"å¿…æ®º: ç„¡æ•µãƒãƒªã‚¢",
    btnPlay:"ãƒ—ãƒ¬ã‚¤",
    btnLocal:"ãƒ­ãƒ¼ã‚«ãƒ«TOP10",
    resultTitle:"RESULT",
    shareLabel:"ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆ",
    btnSaveImage:"ç”»åƒã¨ã—ã¦ä¿å­˜",
    btnBackTitle:"ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹",
    localTitle:"LOCAL TOP10",
    btnLocalClose:"é–‰ã˜ã‚‹",
    hudRespawnPrefix:"ãƒªã‚¹ãƒãƒ¼ãƒ³ã¾ã§ï¼š",
    weeklyTitle:"WEEKLY BEST",
    resultYourRank:"YOUR RANK",
    shareTemplate:"Sky Magic Dogfight\nName: {name}\nRank: {rank}  Kills: {kills}  Zone: {zone}\n#SkyMagicDogfight",
    shareHint:"ãƒ—ãƒ¬ã‚¤å¾Œã®ãƒªã‚¶ãƒ«ãƒˆç”»é¢ã‹ã‚‰ã€çµæœã‚’Xãªã©ã«ã‚·ã‚§ã‚¢ã§ãã¾ã™ã€‚",
    btnCopyShare:"ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼",
    copySuccess:"ã‚·ã‚§ã‚¢ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼",
    copyFail:"ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚",
    lastLabel:"LAST 10s"
  },
  en:{
    title:"Sky Magic Dogfight",
    ui:"PC: WASD + Mouse / Mobile: Twin-stick + ULT button",
    labelName:"Username",
    labelBook:"Select Grimoire",
    labelMode:"Control mode",
    modePc:"PC",
    modeMobile:"Mobile",
    fireTitle:"ğŸ”¥ Fire Grimoire",
    fireSub:"Ultimate: Massive Beam",
    waterTitle:"ğŸ’§ Water Grimoire",
    waterSub:"Ultimate: Invincible Barrier",
    btnPlay:"PLAY",
    btnLocal:"Local TOP10",
    resultTitle:"RESULT",
    shareLabel:"Share text",
    btnSaveImage:"Save as Image",
    btnBackTitle:"Back to Title",
    localTitle:"LOCAL TOP10",
    btnLocalClose:"Close",
    hudRespawnPrefix:"Respawn in: ",
    weeklyTitle:"WEEKLY BEST",
    resultYourRank:"YOUR RANK",
    shareTemplate:"Sky Magic Dogfight\nName: {name}\nRank: {rank}  Kills: {kills}  Zone: {zone}\n#SkyMagicDogfight",
    shareHint:"You can share your result to X from the result screen.",
    btnCopyShare:"Copy text",
    copySuccess:"Share text copied!",
    copyFail:"Copy failed. Please select it manually.",
    lastLabel:"LAST 10s"
  }
};
let lang = "ja";
function applyLanguage(){
  const t = i18n[lang];
  $("menuTitle").textContent = t.title;
  $("pageTitle").textContent = t.title;
  $("ui").textContent = t.ui;
  $("labelName").textContent = t.labelName;
  $("labelBook").textContent = t.labelBook;
  $("labelMode").textContent = t.labelMode;
  $("fireTitle").textContent = t.fireTitle;
  $("fireSub").textContent = t.fireSub;
  $("waterTitle").textContent = t.waterTitle;
  $("waterSub").textContent = t.waterSub;
  modePcBtn.textContent = t.modePc;
  modeMobileBtn.textContent = t.modeMobile;
  playBtn.textContent = t.btnPlay;
  openLocalBtn.textContent = t.btnLocal;
  $("resultTitle").textContent = t.resultTitle;
  $("shareLabel").textContent = t.shareLabel;
  saveImageBtn.textContent = t.btnSaveImage;
  backTitleBtn.textContent = t.btnBackTitle;
  $("localTitle").textContent = t.localTitle;
  closeLocalBtn.textContent = t.btnLocalClose;
  $("shareHint").textContent = t.shareHint;
}

/* ===== å…¥åŠ› ===== */
const keys = {};
const mouse = {x:canvas.width/2, y:canvas.height/2, down:false};

window.addEventListener("keydown", e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.code === "Space"){
    e.preventDefault();
    tryUseUltimate();
  }
});
window.addEventListener("keyup", e=>{
  keys[e.key.toLowerCase()] = false;
});
canvas.addEventListener("mousemove", e=>{
  const r = canvas.getBoundingClientRect();
  const scaleX = canvas.width / r.width;
  const scaleY = canvas.height / r.height;
  mouse.x = (e.clientX - r.left) * scaleX;
  mouse.y = (e.clientY - r.top) * scaleY;
});
canvas.addEventListener("mousedown", ()=>{mouse.down = true;});
canvas.addEventListener("mouseup", ()=>{mouse.down = false;});

/* ===== è¨€èªåˆ‡æ›¿ ===== */
langJaBtn.onclick = ()=>{
  lang="ja";
  langJaBtn.classList.add("active");
  langEnBtn.classList.remove("active");
  applyLanguage();
  loadWeeklyHUD();
};
langEnBtn.onclick = ()=>{
  lang="en";
  langJaBtn.classList.remove("active");
  langEnBtn.classList.add("active");
  applyLanguage();
  loadWeeklyHUD();
};

/* ===== æ“ä½œãƒ¢ãƒ¼ãƒ‰ ===== */
let inputMode = "pc";
modePcBtn.onclick = ()=>{
  inputMode = "pc";
  modePcBtn.classList.add("active");
  modeMobileBtn.classList.remove("active");
};
modeMobileBtn.onclick = ()=>{
  inputMode = "mobile";
  modeMobileBtn.classList.add("active");
  modePcBtn.classList.remove("active");
};

/* ===== ãƒ¢ãƒã‚¤ãƒ«è‡ªå‹•åˆ¤å®š ===== */
function autoInputMode(){
  try{
    if(navigator.maxTouchPoints && navigator.maxTouchPoints>0){
      inputMode = "mobile";
      modeMobileBtn.classList.add("active");
      modePcBtn.classList.remove("active");
    }
  }catch(e){}
}

/* ===== ãƒ¢ãƒã‚¤ãƒ«ã‚¹ãƒ†ã‚£ãƒƒã‚¯ ===== */
let moveX = 0, moveY = 0;
let aimX = 0, aimY = 0;
let leftPointerId = null;
let rightPointerId = null;

function resetStick(isLeft){
  if(isLeft){
    moveX = 0; moveY = 0;
    leftStickInner.style.transform = "translate(-50%,-50%)";
    leftPointerId = null;
  }else{
    aimX = 0; aimY = 0;
    rightStickInner.style.transform = "translate(-50%,-50%)";
    rightPointerId = null;
  }
}
function updateStickFromEvent(e, stickElem, innerElem, isLeft){
  const rect = stickElem.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  let dx = e.clientX - cx;
  let dy = e.clientY - cy;
  const maxR = rect.width/2;
  const dist = Math.hypot(dx,dy);
  if(dist > maxR){
    dx = dx / dist * maxR;
    dy = dy / dist * maxR;
  }
  const vx = dx / maxR;
  const vy = dy / maxR;
  innerElem.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
  if(isLeft){
    moveX = vx;
    moveY = vy;
  }else{
    aimX = vx;
    aimY = vy;
  }
}
function setupStickEvents(){
  leftStick.addEventListener("pointerdown", e=>{
    if(inputMode !== "mobile") return;
    e.preventDefault();
    leftPointerId = e.pointerId;
    leftStick.setPointerCapture(e.pointerId);
    updateStickFromEvent(e,leftStick,leftStickInner,true);
  });
  leftStick.addEventListener("pointermove", e=>{
    if(inputMode !== "mobile") return;
    if(e.pointerId !== leftPointerId) return;
    e.preventDefault();
    updateStickFromEvent(e,leftStick,leftStickInner,true);
  });
  leftStick.addEventListener("pointerup", e=>{
    if(e.pointerId !== leftPointerId) return;
    e.preventDefault();
    leftStick.releasePointerCapture(e.pointerId);
    resetStick(true);
  });
  leftStick.addEventListener("pointercancel", e=>{
    if(e.pointerId !== leftPointerId) return;
    resetStick(true);
  });

  rightStick.addEventListener("pointerdown", e=>{
    if(inputMode !== "mobile") return;
    e.preventDefault();
    rightPointerId = e.pointerId;
    rightStick.setPointerCapture(e.pointerId);
    updateStickFromEvent(e,rightStick,rightStickInner,false);
  });
  rightStick.addEventListener("pointermove", e=>{
    if(inputMode !== "mobile") return;
    if(e.pointerId !== rightPointerId) return;
    e.preventDefault();
    updateStickFromEvent(e,rightStick,rightStickInner,false);
  });
  rightStick.addEventListener("pointerup", e=>{
    if(e.pointerId !== rightPointerId) return;
    e.preventDefault();
    rightStick.releasePointerCapture(e.pointerId);
    resetStick(false);
  });
  rightStick.addEventListener("pointercancel", e=>{
    if(e.pointerId !== rightPointerId) return;
    resetStick(false);
  });

  mobileUltBtn.addEventListener("click", e=>{
    if(inputMode !== "mobile") return;
    e.preventDefault();
    tryUseUltimate();
  });
}

/* ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ===== */
const W = canvas.width;
const H = canvas.height;
const MARGIN = 30;

let bookType = "fire";      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã§é¸ã‚“ã ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”¨
let ultBookType = "fire";   // ç¾åœ¨ç™ºå‹•ä¸­ã®ULTã‚¿ã‚¤ãƒ—ï¼ˆfire / waterï¼‰

let units = [];
let player = null;
let bullets = [];
let zone = null;

let timeLeft = 90;
let lastTime = 0;
let running = false;

let gauge = 0;
let ultActive = false;
let ultTime = 0;
let ultCutinTimer = 0;
let ultOwner = null;   // ç¾åœ¨ã®ULTã®æŒã¡ä¸»ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ or BOTï¼‰
let ultAngle = 0;      // BOTç”¨ã®å›ºå®šè§’åº¦

let playerShotCooldown = 0;
let globalTime = 0;
let lastAimAngle = 0;

const WEEK_KEY = "SMD_WEEKLY";
const LOCAL_KEY = "SMD_LOCAL";

/* ===== èƒŒæ™¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ===== */
let bgObjects = [];
function initBgObjects(){
  bgObjects = [];
  for(let i=0;i<14;i++){
    const layer = 1 + Math.floor(Math.random()*3);
    const r = Math.random();
    const type = r<0.5 ? "cloud" : (r<0.8 ? "island" : "page");
    bgObjects.push({
      x: Math.random()*W,
      y: MARGIN + Math.random()*(H-MARGIN*2),
      layer,
      type,
      offset: Math.random()*Math.PI*2
    });
  }
}
function updateBg(dt){
  const baseSpeeds = {1:5,2:12,3:25};
  for(const o of bgObjects){
    const s = baseSpeeds[o.layer] || 10;
    o.x -= s*dt;
    if(o.x < -80){
      o.x = W + Math.random()*120;
      o.y = MARGIN + Math.random()*(H-MARGIN*2);
    }
  }
}
function drawBg(){
  const g = ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#020617");
  g.addColorStop(0.4,"#02081f");
  g.addColorStop(1,"#0b1220");
  ctx.fillStyle=g;
  ctx.fillRect(0,0,W,H);

  bgObjects.forEach(o=>{
    const par = (o.layer===1?0.25:o.layer===2?0.5:0.9);
    ctx.save();
    ctx.globalAlpha = 0.18 + 0.22*par;
    ctx.translate(o.x,o.y);
    if(o.type==="cloud"){
      ctx.fillStyle="#9ca3af";
      ctx.beginPath();
      ctx.ellipse(0,0,40*par,16*par,0,0,Math.PI*2);
      ctx.ellipse(-20*par,4*par,25*par,10*par,0,0,Math.PI*2);
      ctx.ellipse(18*par,2*par,22*par,9*par,0,0,Math.PI*2);
      ctx.fill();
    }else if(o.type==="island"){
      ctx.fillStyle="#374151";
      ctx.beginPath();
      ctx.moveTo(-22*par,8*par);
      ctx.lineTo(0,-12*par);
      ctx.lineTo(26*par,6*par);
      ctx.lineTo(10*par,14*par);
      ctx.lineTo(-12*par,13*par);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle="#16a34a";
      ctx.fillRect(-14*par,-2*par,28*par,4*par);
    }else{
      ctx.rotate(0.2*Math.sin(globalTime + o.offset));
      ctx.fillStyle="rgba(248,250,252,0.85)";
      ctx.fillRect(-6*par,-9*par,12*par,18*par);
      ctx.fillStyle="#cbd5f5";
      ctx.fillRect(-6*par,-1*par,12*par,2*par);
    }
    ctx.restore();
  });
}

/* ===== æµ®éŠãƒ†ã‚­ã‚¹ãƒˆ ===== */
let floatTexts = [];
class FloatText{
  constructor(x,y,text,color){
    this.x=x; this.y=y;
    this.text=text;
    this.color=color;
    this.life=1;
  }
  update(dt){
    this.y -= 30*dt;
    this.life -= dt;
  }
  draw(){
    if(this.life<=0) return;
    ctx.save();
    ctx.globalAlpha = Math.max(0,this.life);
    ctx.fillStyle = this.color;
    ctx.font = "14px system-ui";
    ctx.textAlign = "center";
    ctx.fillText(this.text, this.x, this.y);
    ctx.restore();
  }
}

/* ===== ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« ===== */
let particles = [];
class Particle{
  constructor(x,y,color){
    this.x=x; this.y=y;
    const a = Math.random()*Math.PI*2;
    const s = 120 + Math.random()*160;
    this.vx = Math.cos(a)*s;
    this.vy = Math.sin(a)*s;
    this.life = 0.6 + Math.random()*0.3;
    this.radius = 2 + Math.random()*3;
    this.color = color;
  }
  update(dt){
    this.x += this.vx*dt;
    this.y += this.vy*dt;
    this.vy += 120*dt*0.2;
    this.life -= dt;
  }
  draw(){
    if(this.life<=0) return;
    ctx.save();
    ctx.globalAlpha = Math.max(0,this.life/0.6);
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}
function spawnDeathEffect(x,y,isPlayer){
  const baseColor = isPlayer ? "rgba(96,165,250,0.95)" : "rgba(251,146,60,0.95)";
  for(let i=0;i<18;i++){
    particles.push(new Particle(x,y,baseColor));
  }
}
function spawnHitSpark(x,y,fromPlayer){
  const baseColor = fromPlayer ? "rgba(251,191,36,0.95)" : "rgba(148,163,184,0.95)";
  for(let i=0;i<7;i++){
    const p = new Particle(x,y,baseColor);
    p.radius = 1 + Math.random()*1.5;
    p.life = 0.25 + Math.random()*0.2;
    particles.push(p);
  }
}

/* ===== é¢¨ãƒ©ã‚¤ãƒ³ï¼ˆé­”åŠ›ã®æµã‚Œï¼‰ ===== */
let windLines = [];
let lastPlayerX = null;
let lastPlayerY = null;

function drawWindLines(){
  ctx.save();
  for(const l of windLines){
    const a = Math.max(0,l.life/0.4);
    const base = (player && player.bookType==="fire")
      ? "rgba(248,113,113,"
      : "rgba(56,189,248,";
    ctx.globalAlpha = a;
    ctx.strokeStyle = base + (0.25+0.45*a) + ")";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(l.x1,l.y1);
    ctx.lineTo(l.x2,l.y2);
    ctx.stroke();
  }
  ctx.restore();
}

/* ===== ã‚­ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ ===== */
let feedLogs = [];
function addFeed(text,color){
  feedLogs.push({text,color,life:3});
}
function drawFeedLogs(){
  ctx.save();
  const x = W-16;
  let y = 90;
  ctx.textAlign = "right";
  ctx.font = "11px system-ui";
  const logs = feedLogs.slice(-4);
  for(const log of logs){
    const a = Math.min(1, log.life/3);
    ctx.globalAlpha = a;
    ctx.fillStyle = log.color;
    ctx.fillText(log.text, x, y);
    y += 14;
  }
  ctx.restore();
}

/* ===== ã‚³ãƒ³ãƒœç®¡ç† ===== */
let comboCount = 0;
let comboTimer = 0;
let comboLabelTimer = 0;
let comboLabelText = "";
let comboLabelColor = "#f97316";

function registerPlayerKill(victim){
  player.kills++;
  comboCount++;
  comboTimer = 4;

  let label = "";
  if(comboCount===2) label = "DOUBLE!";
  else if(comboCount===3) label = "TRIPLE!";
  else if(comboCount===4) label = "QUAD!";
  else if(comboCount>=5) label = "RAMPAGE!";

  floatTexts.push(new FloatText(player.x, player.y-40, "+1 KILL", "#f97316"));
  addFeed(`You KO'd ${victim.name}`, "#fbbf24");

  if(label){
    comboLabelText = label;
    comboLabelColor = "#f97316";
    comboLabelTimer = 1.2;
    addFeed(label,"#f97316");
  }

  triggerHitStop(0.08);
}

function drawComboLabel(){
  if(comboLabelTimer<=0 || !comboLabelText) return;
  ctx.save();
  const maxT = 1.2;
  const p = comboLabelTimer / maxT;
  const alpha = Math.min(1, comboLabelTimer/0.2, p+0.2);
  ctx.globalAlpha = alpha;
  ctx.fillStyle = comboLabelColor;
  ctx.font = "bold 32px system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  const y = H*0.35;
  ctx.fillText(comboLabelText, W/2, y);
  ctx.restore();
}

/* ===== ãƒªãƒ¼ãƒ€ãƒ¼ç‹å†  ===== */
let leaderUnit = null;

/* ===== ãƒ¦ãƒ‹ãƒƒãƒˆãƒ»å¼¾ ===== */
class Unit {
  constructor(x,y,isPlayer,name){
    this.x = x;
    this.y = y;
    this.isPlayer = isPlayer;
    this.name = name;
    this.maxHp = isPlayer ? 150 : 100;
    this.hp = this.maxHp;

    // â˜… å„ãƒ¦ãƒ‹ãƒƒãƒˆå›ºæœ‰ã®é­”å°æ›¸ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é¸æŠã€BOTã¯ç«/æ°´ã‚’ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
    this.bookType = isPlayer ? bookType : (Math.random() < 0.5 ? "fire" : "water");

    this.kills = 0;
    this.zoneScore = 0;
    this.dead = false;
    this.respawn = 0;
    this.dir = Math.random()*Math.PI*2;
    this.zoneFocus = Math.random()<0.6;
    this.botShotCooldown = 0;
    this.zoneFloatTimer = 0;
    this.botUltTimer = 4 + Math.random()*4;
  }
  update(dt){
    if(this.dead){
      this.respawn -= dt;
      if(this.respawn <= 0){
        this.dead = false;
        this.hp = this.maxHp;
        this.x = MARGIN + Math.random()*(W-MARGIN*2);
        this.y = MARGIN + Math.random()*(H-MARGIN*2);
      }
      return;
    }

    const speed = this.isPlayer ? 260 : 150;

    if(this.isPlayer){
      let ax = 0, ay = 0;
      if(inputMode === "pc"){
        ax = (keys["a"]?-1:0) + (keys["d"]?1:0);
        ay = (keys["w"]?-1:0) + (keys["s"]?1:0);
        if(ax!==0 || ay!==0){
          const len = Math.hypot(ax,ay);
          ax/=len; ay/=len;
        }
      }else{
        ax = moveX;
        ay = moveY;
      }
      if(ax!==0 || ay!==0){
        const len = Math.hypot(ax,ay);
        if(len>1){ ax/=len; ay/=len; }
        this.x += ax*speed*dt;
        this.y += ay*speed*dt;
      }
    }else{
      if(zone && this.zoneFocus){
        const a = Math.atan2(zone.y-this.y, zone.x-this.x);
        this.x += Math.cos(a)*speed*dt;
        this.y += Math.sin(a)*speed*dt;
      }else{
        this.x += Math.cos(this.dir)*speed*dt;
        this.y += Math.sin(this.dir)*speed*dt;
      }
      if(this.x<MARGIN || this.x>W-MARGIN) this.dir = Math.PI - this.dir;
      if(this.y<MARGIN || this.y>H-MARGIN) this.dir = -this.dir;

      // â˜… BOT ULT AIï¼šä¸€å®šé–“éš”ã§ãƒ©ãƒ³ãƒ€ãƒ ç™ºå‹•ã‚’è©¦ã¿ã‚‹
      this.botUltTimer -= dt;
      if(this.botUltTimer <= 0){
        if(timeLeft > 5){
          tryUseBotUltimate(this);
        }
        this.botUltTimer = 6 + Math.random()*6;
      }
    }

    this.x = Math.max(MARGIN, Math.min(W-MARGIN, this.x));
    this.y = Math.max(MARGIN, Math.min(H-MARGIN, this.y));

    if(zone && !this.dead){
      const d = Math.hypot(this.x-zone.x, this.y-zone.y);
      if(d < zone.r){
        if(this.isPlayer){
          gauge = Math.min(100, gauge + dt*20);
          this.zoneFloatTimer -= dt;
          if(this.zoneFloatTimer <= 0){
            this.zoneFloatTimer = 0.4;
            this.zoneScore += 2;
            floatTexts.push(new FloatText(this.x, this.y-32, "+2", "#60a5fa"));
          }
        }else{
          this.zoneScore += 2 * dt / 0.4;
        }
      }else if(this.isPlayer){
        this.zoneFloatTimer = 0;
      }
    }

    if(!this.isPlayer){
      this.botShotCooldown -= dt;
      if(this.botShotCooldown <= 0){
        this.botShotCooldown = 0.9 + Math.random()*0.6;
        botShoot(this);
      }
    }
  }

  draw(){
    if(this.dead){
      ctx.save();
      ctx.strokeStyle="#6b7280";
      ctx.setLineDash([4,4]);
      ctx.beginPath();
      ctx.arc(this.x,this.y,12,0,Math.PI*2);
      ctx.stroke();
      ctx.restore();
      return;
    }

    // â˜… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã ã‘è¼ªéƒ­ã‚’å…‰ã‚‰ã›ã‚‹ï¼ˆè‰²ã¯è‡ªèº«ã®bookTypeï¼‰
    if(this.isPlayer){
      ctx.save();
      const pulse = (Math.sin(globalTime*6)+1)/2;
      const glowR = 28 + 4*pulse;
      const inner = (this.bookType==="fire")
        ? "rgba(248,113,113,0.75)"
        : "rgba(56,189,248,0.75)";
      const outer = "rgba(15,23,42,0)";
      const g = ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,glowR);
      g.addColorStop(0, inner);
      g.addColorStop(1, outer);
      ctx.globalAlpha = 0.9;
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(this.x,this.y,glowR,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // â˜… é­”å°æ›¸æœ¬ä½“ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ»BOTå…±é€šã€bookTypeã§è‰²åˆ†ã‘ï¼‰
    const bob = Math.sin(globalTime*4 + (this.isPlayer ? 0 : this.x*0.01))*1.5;
    drawPlayerBookShape(
      this.x,
      this.y + bob,
      this.isPlayer ? 1 : 0.9,
      this.isPlayer ? 1 : 0.95,
      this.bookType
    );

    ctx.save();
    ctx.fillStyle="rgba(15,23,42,0.9)";
    ctx.fillRect(this.x-18,this.y-22,36,4);
    ctx.fillStyle="#22c55e";
    ctx.fillRect(this.x-18,this.y-22,36*(this.hp/this.maxHp),4);
    ctx.restore();

    if(this.isPlayer){
      ctx.save();
      ctx.globalAlpha=0.7;
      ctx.fillStyle="#e5e7eb";
      ctx.font="11px system-ui";
      ctx.textAlign="center";
      ctx.fillText(this.name, this.x, this.y-30);
      ctx.restore();
    }

    if(this===leaderUnit && !this.dead){
      ctx.save();
      ctx.translate(this.x, this.y-34);
      ctx.fillStyle="rgba(250,204,21,0.96)";
      ctx.beginPath();
      ctx.moveTo(-10,7);
      ctx.lineTo(-6,-4);
      ctx.lineTo(-1,3);
      ctx.lineTo(4,-4);
      ctx.lineTo(9,7);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle="rgba(30,64,175,0.9)";
      ctx.fillRect(-8,6,16,3);
      ctx.restore();
    }
  }
}

function drawPlayerBookShape(x,y,alpha,scale,book){
  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.translate(x,y);
  ctx.scale(scale,scale);

  const color = (book==="fire") ? "#f97373" : "#60a5fa";
  const runeColor = (book==="fire") ? "#facc15" : "#bfdbfe";

  ctx.fillStyle = color;
  ctx.strokeStyle = "#f9fafb";
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.moveTo(-18,-11);
  ctx.lineTo(8,-11);
  ctx.lineTo(16,-5);
  ctx.lineTo(16,11);
  ctx.lineTo(-18,11);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(-10,-11);
  ctx.lineTo(-10,11);
  ctx.stroke();

  ctx.fillStyle=runeColor;
  ctx.font="9px system-ui";
  ctx.textAlign="left";
  ctx.textBaseline="middle";
  ctx.fillText("áš±áš¢áš¾á›–", -6, -4);

  ctx.font="12px system-ui";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillStyle="rgba(249,250,251,0.95)";
  ctx.fillText(book==="fire"?"ğŸ”¥":"ğŸ’§", 2, 3);

  ctx.restore();
}

class Bullet{
  constructor(x,y,angle,speed,damage,owner){
    this.x=x; this.y=y;
    this.vx=Math.cos(angle)*speed;
    this.vy=Math.sin(angle)*speed;
    this.damage=damage;
    this.owner=owner;
  }
  update(dt){
    this.x += this.vx*dt;
    this.y += this.vy*dt;
  }
}

/* ===== é­”å°æ›¸é¸æŠ ===== */
fireBookBtn.addEventListener("click", ()=>{
  bookType = "fire";
  fireBookBtn.classList.add("active");
  waterBookBtn.classList.remove("active");
});
waterBookBtn.addEventListener("click", ()=>{
  bookType = "water";
  waterBookBtn.classList.add("active");
  fireBookBtn.classList.remove("active");
});

/* ===== ã‚²ãƒ¼ãƒ é–‹å§‹ ===== */
playBtn.addEventListener("click", ()=>{
  unlockAudio();
  startGame();
});
backTitleBtn.addEventListener("click", ()=>{
  resultOverlay.style.display="none";
  menuOverlay.style.display="flex";
  mobileControls.style.display="none";
});
openLocalBtn.addEventListener("click", showLocalRanking);
closeLocalBtn.addEventListener("click", ()=>{ localOverlay.style.display="none"; });
saveImageBtn.addEventListener("click", saveResultImage);

/* ===== ã‚·ã‚§ã‚¢ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼ ===== */
copyShareBtn.addEventListener("click", ()=>{
  const text = shareText.value;
  const t = i18n[lang];
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text)
      .then(()=>alert(t.copySuccess))
      .catch(()=>fallbackCopy(t));
  }else{
    fallbackCopy(t);
  }
});
function fallbackCopy(t){
  shareText.select();
  try{
    document.execCommand("copy");
    alert(t.copySuccess);
  }catch(e){
    alert(t.copyFail);
  }
  shareText.blur();
}

function startGame(){
  units = [];
  bullets = [];
  floatTexts = [];
  particles = [];
  windLines = [];
  feedLogs = [];
  leaderUnit = null;
  zone = null;
  timeLeft = 90;
  lastTime = performance.now();
  gauge = 0;
  ultActive = false;
  ultTime = 0;
  ultCutinTimer = 0;
  ultOwner = null;
  ultBookType = "fire";
  ultAngle = 0;
  playerShotCooldown = 0;
  globalTime = 0;
  lastAimAngle = 0;
  moveX = moveY = 0;
  aimX = aimY = 0;
  comboCount = 0;
  comboTimer = 0;
  comboLabelTimer = 0;
  comboLabelText = "";

  const name = (nameInput.value.trim() || "Player");
  player = new Unit(W/2, H/2, true, name);
  units.push(player);

  for(let i=0;i<5;i++){
    const bot = new Unit(
      MARGIN + Math.random()*(W-MARGIN*2),
      MARGIN + Math.random()*(H-MARGIN*2),
      false,
      "BOT"+(i+1)
    );
    units.push(bot);
  }

  lastPlayerX = player.x;
  lastPlayerY = player.y;

  initBgObjects();

  menuOverlay.style.display="none";
  resultOverlay.style.display="none";
  localOverlay.style.display="none";

  loadWeeklyHUD();
  running = true;

  mobileControls.style.display = (inputMode === "mobile") ? "block" : "none";

  requestAnimationFrame(gameLoop);
}

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
function gameLoop(timestamp){
  if(!running) return;
  const dtReal = (timestamp - lastTime)/1000;
  lastTime = timestamp;
  globalTime += dtReal;

  updateGame(dtReal);
  drawGame();

  if(running) requestAnimationFrame(gameLoop);
}

let zoneSpawnTimer = 0;

function updateGame(dtReal){
  let dt = dtReal;

  if(hitStopTimer>0){
    hitStopTimer -= dtReal;
    if(hitStopTimer<0) hitStopTimer=0;
    dt *= 0.15;
  }

  timeLeft -= dt;
  if(timeLeft <= 0){
    timeLeft = 0;
    running = false;
    showResult();
    return;
  }

  if(shakeTimer>0){
    shakeTimer -= dtReal;
    if(shakeTimer<0){ shakeTimer=0; shakeIntensity=0; }
  }

  updateBg(dt);

  gauge = Math.min(100, gauge + dt*5);
  playerShotCooldown -= dt;

  if(!zone){
    zoneSpawnTimer -= dt;
    if(zoneSpawnTimer <= 0){
      zoneSpawnTimer = 5 + Math.random()*6;
      zone = {
        x: MARGIN+120+Math.random()*(W-MARGIN*2-240),
        y: MARGIN+80+Math.random()*(H-MARGIN*2-160),
        r: 80,
        time: 15,
        spawn: 0
      };
      units.forEach(u=>{ if(!u.isPlayer) u.zoneFocus = Math.random()<0.6; });
      playSE(seZone);
    }
  }else{
    zone.time -= dt;
    zone.spawn += dt;
    if(zone.time<=0){
      zone = null;
    }
  }

  units.forEach(u=>u.update(dt));

  // ãƒªãƒ¼ãƒ€ãƒ¼æ›´æ–°ï¼ˆåˆè¨ˆãƒã‚¤ãƒ³ãƒˆåŸºæº–ï¼‰
  leaderUnit = null;
  let best = null;
  for(const u of units){
    if(u.dead) continue;
    const total = u.kills + u.zoneScore;
    if(!best || total>best.total){
      best = {u,total};
    }
  }
  leaderUnit = best ? best.u : null;

  const canShoot = !player.dead && !(player.bookType==="water" && ultActive && ultOwner===player) && playerShotCooldown<=0;
  if(canShoot){
    if(inputMode === "pc" && mouse.down){
      playerShoot();
      playerShotCooldown = 0.18;
    }else if(inputMode === "mobile"){
      const len = Math.hypot(aimX,aimY);
      if(len > 0.3){
        const angle = Math.atan2(aimY,aimX);
        playerShoot(angle);
        playerShotCooldown = 0.18;
      }
    }
  }

  const newBullets = [];
  const hitRadius = 16;

  for(const b of bullets){
    b.update(dt);
    if(b.x<0 || b.x>W || b.y<0 || b.y>H) continue;

    let alive = true;
    for(const u of units){
      if(u.dead || u===b.owner) continue;

      // â˜… æ°´ULTä¸­ã®æŒã¡ä¸»ã ã‘ãƒãƒªã‚¢ã§å¼¾ã‚’é˜²ã
      if(u === ultOwner && ultBookType==="water" && ultActive){
        const distShield = Math.hypot(u.x-b.x,u.y-b.y);
        if(distShield < 40){
          alive = false;
          break;
        }
      }

      const d = Math.hypot(u.x-b.x, u.y-b.y);
      if(d < hitRadius){
        u.hp -= b.damage;
        if(u.hp <= 0){
          killUnit(u,b.owner);
        }else{
          spawnHitSpark(b.x,b.y,b.owner===player);
        }
        alive = false;
        break;
      }
    }
    if(alive) newBullets.push(b);
  }
  bullets = newBullets;

  // â˜… ULTå…±é€šå‡¦ç†ï¼šæŒã¡ä¸»ã¨ULTã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦å‡¦ç†
  if(ultActive && ultOwner){
    if(ultBookType === "fire"){
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç«ULTã¯ç…§æº–æ–¹å‘ã«è¿½å¾“ã€BOTã¯ç™ºå‹•æ™‚ã®è§’åº¦å›ºå®š
      const angle = (ultOwner === player) ? lastAimAngle : ultAngle;
      const beamLen = 1200;
      const bx1 = ultOwner.x;
      const by1 = ultOwner.y;
      const bx2 = bx1 + Math.cos(angle)*beamLen;
      const by2 = by1 + Math.sin(angle)*beamLen;
      const dx = bx2 - bx1;
      const dy = by2 - by1;
      const len2 = dx*dx + dy*dy;
      const beamWidth = 32;

      for(const u of units){
        if(u.dead || u === ultOwner) continue;
        const t = ((u.x-bx1)*dx + (u.y-by1)*dy) / len2;
        if(t<0 || t>1) continue;
        const px = bx1 + dx*t;
        const py = by1 + dy*t;
        const dist = Math.hypot(u.x-px,u.y-py);
        if(dist < beamWidth){
          const before = u.hp;
          u.hp -= 220*dt;
          if(before>0 && u.hp<=0){
            killUnit(u,ultOwner);
          }
        }
      }
    }else if(ultBookType === "water"){
      // ãƒãƒªã‚¢æœ¬ä½“ã¯å¼¾å´åˆ¤å®šã§å‡¦ç†æ¸ˆã¿
    }

    ultTime -= dt;
    if(ultTime <= 0 || ultOwner.dead){
      ultActive = false;
      ultTime = 0;
      ultOwner = null;
    }
  }

  // ç…§æº–è§’åº¦ã‚’æ›´æ–°ï¼ˆULTä¸­ã‚‚å¸¸ã«æœ€æ–°æ–¹å‘ã‚’è¨˜éŒ²ï¼‰
  if(player && !player.dead){
    if(inputMode === "pc"){
      const dx = mouse.x - player.x;
      const dy = mouse.y - player.y;
      if(dx !== 0 || dy !== 0){
        lastAimAngle = Math.atan2(dy,dx);
      }
    }else{
      if(aimX !== 0 || aimY !== 0){
        lastAimAngle = Math.atan2(aimY,aimX);
      }
    }
  }

  floatTexts = floatTexts.filter(ft=>{ ft.update(dt); return ft.life>0; });
  particles = particles.filter(p=>{ p.update(dt); return p.life>0; });
  feedLogs = feedLogs.filter(log=>{ log.life -= dt; return log.life>0; });

  if(comboTimer>0){
    comboTimer -= dt;
    if(comboTimer<=0){
      comboTimer=0;
      comboCount=0;
    }
  }
  if(comboLabelTimer>0){
    comboLabelTimer -= dt;
    if(comboLabelTimer<0) comboLabelTimer = 0;
  }

  if(player && !player.dead && dtReal>0){
    if(lastPlayerX!=null){
      const dx = player.x - lastPlayerX;
      const dy = player.y - lastPlayerY;
      const dist = Math.hypot(dx,dy);
      const speed = dist / dtReal;
      if(speed > 220){
        const linesToSpawn = 1 + Math.floor(speed/260);
        const baseAngle = Math.atan2(dy,dx) + Math.PI;
        for(let i=0;i<linesToSpawn;i++){
          const angle = baseAngle + (Math.random()-0.5)*0.5;
          const len = 25 + Math.random()*20;
          const off = 5 + Math.random()*10;
          const x2 = player.x + Math.cos(angle)*off;
          const y2 = player.y + Math.sin(angle)*off;
          const x1 = x2 + Math.cos(angle)*len;
          const y1 = y2 + Math.sin(angle)*len;
          windLines.push({x1,y1,x2,y2,life:0.4});
        }
      }
    }
    lastPlayerX = player.x;
    lastPlayerY = player.y;
  }else{
    lastPlayerX = player ? player.x : null;
    lastPlayerY = player ? player.y : null;
  }

  windLines = windLines.filter(l=>{ l.life -= dt; return l.life>0; });

  updateHUD();
}

/* ===== ãƒ¦ãƒ‹ãƒƒãƒˆæ’ƒå¢œå…±é€šå‡¦ç† ===== */
function killUnit(victim, attacker){
  if(victim.dead) return;
  victim.dead = true;
  victim.respawn = 3;
  victim.hp = 0;

  spawnDeathEffect(victim.x,victim.y,victim.isPlayer);
  playSE(seDeath);

  if(victim === ultOwner && ultActive){
    ultActive = false;
    ultTime = 0;
    ultOwner = null;
  }

  if(attacker === player && !victim.isPlayer){
    registerPlayerKill(victim);
  }

  if(victim === player && attacker){
    comboCount = 0;
    comboTimer = 0;
    comboLabelTimer = 0;
    comboLabelText = "";
    addFeed(`You were KO'd by ${attacker.name}`,"#fca5a5");
    triggerHitStop(0.12);
  }
}

/* ===== é­”åŠ›ã‚ªãƒ¼ãƒ©ï¼ˆæ–¹å‘æ€§ä»˜ãï¼‰ ===== */
function drawMagicAura(){
  if(!player || player.dead) return;
  const angle = lastAimAngle;
  const base = (player.bookType==="fire")
    ? "rgba(248,113,113,"
    : "rgba(56,189,248,";
  ctx.save();
  ctx.translate(player.x, player.y);
  for(let i=-2;i<=2;i++){
    const a = angle + i*0.2;
    const len = 30 + 6*Math.sin(globalTime*5 + i);
    const back = -10;
    const x1 = Math.cos(a)*back;
    const y1 = Math.sin(a)*back;
    const x2 = Math.cos(a)*len;
    const y2 = Math.sin(a)*len;
    const grad = ctx.createLinearGradient(x1,y1,x2,y2);
    grad.addColorStop(0, base+"0)");
    grad.addColorStop(0.3, base+"0.4)");
    grad.addColorStop(1, base+"0)");
    ctx.strokeStyle = grad;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
  }
  ctx.restore();
}

/* ===== æ•µã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠï¼ˆBOTåŒå£«ã‚‚æ’ƒã¡åˆã†ï¼‰ ===== */
function findNearestEnemy(src){
  let best = null;
  let bestDist = Infinity;
  for(const u of units){
    if(u.dead || u === src) continue;
    const d = Math.hypot(u.x - src.x, u.y - src.y);
    if(d < bestDist){
      bestDist = d;
      best = u;
    }
  }
  return best;
}

/* ===== æç”» ===== */
function drawGame(){
  ctx.clearRect(0,0,W,H);

  ctx.save();
  if(shakeTimer>0){
    const amt = shakeIntensity * (shakeTimer*10);
    const ox = (Math.random()*2-1)*amt;
    const oy = (Math.random()*2-1)*amt;
    ctx.translate(ox,oy);
  }

  drawBg();
  drawWindLines();

  // ã‚¹ãƒ†ãƒ¼ã‚¸æ ï¼ˆãƒ©ã‚¹ãƒˆ10ç§’ã§ç™ºå…‰ï¼‰
  ctx.save();
  let borderColor = "#4b5563";
  let borderWidth = 2;
  if(timeLeft <= 10){
    const pulse = (Math.sin(globalTime*10)+1)/2;
    borderColor = `rgba(248,181,71,${0.7+0.3*pulse})`;
    borderWidth = 2 + 1.5*pulse;
  }
  ctx.strokeStyle = borderColor;
  ctx.lineWidth = borderWidth;
  ctx.strokeRect(MARGIN,MARGIN,W-MARGIN*2,H-MARGIN*2);
  ctx.restore();

  // ã‚¾ãƒ¼ãƒ³
  if(zone){
    ctx.save();
    const pulse = (Math.sin(globalTime*4)+1)/2;
    const glowR = zone.r + 6*pulse;

    const g = ctx.createRadialGradient(zone.x,zone.y,zone.r*0.6,zone.x,zone.y,glowR);
    g.addColorStop(0,"rgba(129,140,248,0.0)");
    g.addColorStop(1,"rgba(129,140,248,0.5)");
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(zone.x,zone.y,glowR,0,Math.PI*2);
    ctx.fill();

    if(zone.spawn < 0.6){
      const t = zone.spawn / 0.6;
      ctx.globalAlpha = 1 - t;
      ctx.strokeStyle = "rgba(191,219,254,0.9)";
      ctx.lineWidth = 2;
      const rr = zone.r * (0.3 + 1.2*t);
      ctx.beginPath();
      ctx.arc(zone.x,zone.y,rr,0,Math.PI*2);
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    ctx.strokeStyle="#c7d2fe";
    ctx.lineWidth=2+1.5*pulse;
    ctx.beginPath();
    ctx.arc(zone.x,zone.y,zone.r,0,Math.PI*2);
    ctx.stroke();

    ctx.beginPath();
    for(let i=0;i<5;i++){
      const a = i*2*Math.PI/5 - Math.PI/2;
      const x = zone.x + Math.cos(a)*zone.r*0.9;
      const y = zone.y + Math.sin(a)*zone.r*0.9;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.stroke();

    ctx.save();
    ctx.translate(zone.x,zone.y);
    ctx.rotate(globalTime*0.6);
    ctx.strokeStyle="rgba(196,181,253,0.65)";
    ctx.lineWidth=1;
    ctx.setLineDash([4,4]);
    for(let i=0;i<3;i++){
      const rr = zone.r*0.45 + i*8;
      ctx.beginPath();
      ctx.arc(0,0,rr,0,Math.PI*2);
      ctx.stroke();
    }
    ctx.restore();

    ctx.restore();
  }

  drawMagicAura();

  // å¼¾
  for(const b of bullets){
    ctx.save();
    const tailX = b.x - b.vx*0.04;
    const tailY = b.y - b.vy*0.04;

    let tailColor, inner0, inner1, outer;
    if(b.owner && b.owner.isPlayer){
      if(b.owner.bookType === "fire"){
        tailColor = "rgba(248,113,113,0.7)";
        inner0 = "#fee2e2";
        inner1 = "#f97373";
        outer  = "rgba(248,113,113,0.0)";
      }else{
        tailColor = "rgba(56,189,248,0.7)";
        inner0 = "#e0f2fe";
        inner1 = "#38bdf8";
        outer  = "rgba(56,189,248,0.0)";
      }
    }else{
      tailColor = "rgba(251,191,36,0.6)";
      inner0 = "#fef3c7";
      inner1 = "#fbbf24";
      outer  = "rgba(248,113,113,0.1)";
    }

    ctx.beginPath();
    ctx.moveTo(tailX,tailY);
    ctx.lineTo(b.x,b.y);
    ctx.strokeStyle = tailColor;
    ctx.lineWidth = 2;
    ctx.stroke();

    const rad = 7;
    const grad = ctx.createRadialGradient(b.x,b.y,0,b.x,b.y,rad);
    grad.addColorStop(0,inner0);
    grad.addColorStop(0.6,inner1);
    grad.addColorStop(1,outer);
    ctx.fillStyle=grad;
    ctx.beginPath();
    ctx.arc(b.x,b.y,rad,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  units.forEach(u=>u.draw());

  // ULTä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  if(ultActive && ultOwner && !ultOwner.dead){
    if(ultBookType==="fire"){
      ctx.save();
      const grad = ctx.createRadialGradient(
        ultOwner.x,ultOwner.y,0,
        ultOwner.x,ultOwner.y,Math.max(W,H)*0.9
      );
      grad.addColorStop(0,"rgba(0,0,0,0)");
      grad.addColorStop(1,"rgba(15,23,42,0.9)");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,W,H);
      ctx.restore();
    }else{
      ctx.save();
      const grad = ctx.createRadialGradient(
        ultOwner.x,ultOwner.y,0,
        ultOwner.x,ultOwner.y,Math.max(W,H)*0.7
      );
      grad.addColorStop(0,"rgba(56,189,248,0.16)");
      grad.addColorStop(1,"rgba(15,23,42,0.8)");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,W,H);
      ctx.restore();
    }
  }

  // ULTãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
  if(ultActive && ultOwner && !ultOwner.dead){
    if(ultBookType === "fire"){
      const angle = (ultOwner === player) ? lastAimAngle : ultAngle;
      const beamLen = 1200;

      ctx.save();
      ctx.translate(ultOwner.x,ultOwner.y);
      ctx.rotate(globalTime*1.2);
      ctx.strokeStyle="rgba(251,191,36,0.95)";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(0,0,46,0,Math.PI*2);
      ctx.stroke();

      ctx.setLineDash([6,4]);
      ctx.beginPath();
      for(let i=0;i<8;i++){
        const a=i*Math.PI/4;
        const x=Math.cos(a)*46;
        const y=Math.sin(a)*46;
        ctx.moveTo(x,y);
        ctx.lineTo(x*0.4,y*0.4);
      }
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();

      ctx.save();
      ctx.lineWidth=26;
      const grad = ctx.createLinearGradient(
        ultOwner.x,ultOwner.y,
        ultOwner.x + Math.cos(angle)*beamLen,
        ultOwner.y + Math.sin(angle)*beamLen
      );
      grad.addColorStop(0,"rgba(251,191,36,0.15)");
      grad.addColorStop(0.25,"rgba(251,191,36,0.95)");
      grad.addColorStop(0.6,"rgba(248,113,113,0.8)");
      grad.addColorStop(1,"rgba(248,113,113,0.0)");
      ctx.strokeStyle=grad;
      ctx.beginPath();
      ctx.moveTo(ultOwner.x,ultOwner.y);
      ctx.lineTo(
        ultOwner.x + Math.cos(angle)*beamLen,
        ultOwner.y + Math.sin(angle)*beamLen
      );
      ctx.stroke();
      ctx.restore();

      ctx.save();
      ctx.lineWidth=2;
      ctx.strokeStyle="rgba(252,211,77,0.7)";
      for(let i=-1;i<=1;i+=2){
        ctx.beginPath();
        const offset = 12*i;
        const sx = ultOwner.x + Math.cos(angle+Math.PI/2)*offset;
        const sy = ultOwner.y + Math.sin(angle+Math.PI/2)*offset;
        const ex = sx + Math.cos(angle)*280;
        const ey = sy + Math.sin(angle)*280;
        ctx.moveTo(sx,sy);
        ctx.lineTo(ex,ey);
        ctx.stroke();
      }
      ctx.restore();

    }else if(ultBookType === "water"){
      ctx.save();
      ctx.strokeStyle="rgba(96,165,250,0.95)";
      ctx.lineWidth=5;
      ctx.beginPath();
      ctx.arc(ultOwner.x,ultOwner.y,42,0,Math.PI*2);
      ctx.stroke();

      ctx.globalAlpha=0.7;
      ctx.beginPath();
      for(let i=0;i<6;i++){
        const a = i*Math.PI/3;
        const x = ultOwner.x + Math.cos(a)*42;
        const y = ultOwner.y + Math.sin(a)*42;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.closePath();
      ctx.strokeStyle="rgba(191,219,254,0.8)";
      ctx.lineWidth=2;
      ctx.stroke();

      ctx.restore();
    }
  }

  particles.forEach(p=>p.draw());
  floatTexts.forEach(ft=>ft.draw());

  drawUltGauge();
  drawComboLabel();
  drawFeedLogs();

  // ULTã‚«ãƒƒãƒˆã‚¤ãƒ³
  if(ultCutinTimer>0){
    ctx.save();
    const tNorm = ultCutinTimer/0.25;
    ctx.globalAlpha = 0.8*tNorm;
    ctx.fillStyle="rgba(15,23,42,0.9)";
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha = 0.9*tNorm;
    ctx.fillStyle = (bookType==="fire") ? "#fed7aa" : "#bfdbfe";
    ctx.font = "bold 34px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const label = (bookType==="fire") ? "FIRE ULTIMATE" : "WATER ULTIMATE";
    ctx.fillText(label, W/2, H*0.3);

    ctx.font = "13px system-ui";
    ctx.globalAlpha = 0.7*tNorm;
    ctx.fillText("SPACE / ULT BUTTON", W/2, H*0.3+32);
    ctx.restore();
    ultCutinTimer -= 1/60;
    if(ultCutinTimer<0) ultCutinTimer=0;
  }

  // ãƒ©ã‚¹ãƒˆ10ç§’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
  if(timeLeft > 0 && timeLeft <= 10){
    ctx.save();
    const boxW = 140;
    const boxH = 60;
    const x = W/2 - boxW/2;
    const y = 18;
    ctx.globalAlpha = 0.75;
    ctx.fillStyle = "rgba(15,23,42,0.85)";
    ctx.fillRect(x,y,boxW,boxH);
    ctx.strokeStyle = "rgba(248,250,252,0.8)";
    ctx.lineWidth = 1.5;
    ctx.strokeRect(x,y,boxW,boxH);
    ctx.globalAlpha = 1;

    const tLang = i18n[lang];
    ctx.fillStyle = "#fbbf24";
    ctx.font = "32px system-ui";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(String(Math.ceil(timeLeft)), W/2, y+26);

    ctx.fillStyle = "#e5e7eb";
    ctx.font = "11px system-ui";
    ctx.fillText(tLang.lastLabel, W/2, y+46);
    ctx.restore();
  }

  ctx.restore();
}

/* ===== å°„æ’ƒ ===== */
function playerShoot(angleOverride){
  const angle = (typeof angleOverride === "number")
    ? angleOverride
    : Math.atan2(mouse.y-player.y, mouse.x-player.x);
  const speed = 500;
  bullets.push(new Bullet(player.x,player.y,angle,speed,26,player));
}

function botShoot(bot){
  const target = findNearestEnemy(bot);
  if(!target) return;
  const angle = Math.atan2(target.y - bot.y, target.x - bot.x);
  bullets.push(new Bullet(bot.x,bot.y,angle,480,18,bot));
}

/* ===== BOTç”¨ ULT ===== */
function tryUseBotUltimate(bot){
  if(!running) return;
  if(ultActive) return; // æ—¢ã«ä½•ã‹ã®ULTä¸­ãªã‚‰BOTå´ã¯å¾…æ©Ÿ

  ultActive = true;
  ultOwner = bot;
  ultBookType = bot.bookType; // BOTã®å±æ€§ã§ULTç¨®åˆ¥ã‚’æ±ºå®š

  if(bot.bookType === "fire"){
    ultTime = 3;
    const target = findNearestEnemy(bot);
    if(target){
      ultAngle = Math.atan2(target.y - bot.y, target.x - bot.x);
    }else{
      ultAngle = Math.random()*Math.PI*2;
    }
    playSE(seUltFire);
  }else{
    ultTime = 5; // æ°´ULTã¯5ç§’ãƒãƒªã‚¢
    ultAngle = 0;
    playSE(seUltWater);
  }
  triggerHitStop(0.09);
}

/* ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ULT ===== */
function tryUseUltimate(){
  if(!running) return;
  // â˜… è‡ªåˆ†ã®ULTä¸­ã ã‘å†ç™ºå‹•ç¦æ­¢ã€‚æ•µãŒULTä¸­ã§ã‚‚ç™ºå‹•å¯èƒ½
  if(ultActive && ultOwner === player) return;
  if(gauge < 100) return;

  ultActive = true;
  ultOwner = player;
  ultBookType = player.bookType; // ç™ºå‹•æ™‚ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é­”å°æ›¸ã§ULTç¨®åˆ¥æ±ºå®š
  gauge = 0;

  if(player.bookType === "fire"){
    ultTime = 3;
    ultAngle = lastAimAngle;
    playSE(seUltFire);
  }else{
    ultTime = 5; // æ°´ULTã¯5ç§’ç„¡æ•µãƒãƒªã‚¢
    ultAngle = lastAimAngle;
    playSE(seUltWater);
  }

  ultCutinTimer = 0.25;
  triggerHitStop(0.09);
}

/* ===== HUD ===== */
function updateHUD(){
  const total = player.kills + player.zoneScore;
  hudLeft.textContent =
    `TIME ${timeLeft.toFixed(1)}s\n`+
    `KILLS ${player.kills}\n`+
    `ZONE ${player.zoneScore.toFixed(0)}\n`+
    `TOTAL ${(total).toFixed(0)}`;

  const bookLabel = player ? player.bookType.toUpperCase() : bookType.toUpperCase();
  hudRight.textContent =
    `BOOK ${bookLabel}\n`+
    `GAUGE ${Math.floor(gauge)}%` +
    (gauge>=100 ? "\nULT READY!" : "") +
    (comboCount>1 ? `\nCOMBO x${comboCount}` : "");

  if(player.dead){
    const t = i18n[lang];
    const suffix = (lang==="ja"?"ç§’":"s");
    respawnHUD.textContent = `${t.hudRespawnPrefix}${player.respawn.toFixed(1)}${suffix}`;
  }else{
    respawnHUD.textContent = "";
  }

  if(inputMode === "mobile"){
    if(gauge>=100 && !ultActive){
      mobileUltBtn.classList.remove("disabled");
    }else{
      mobileUltBtn.classList.add("disabled");
    }
  }
}

function drawUltGauge(){
  const barW = 220;
  const barH = 10;
  const gx = 20;
  const gy = H - 24;

  ctx.save();
  ctx.fillStyle="rgba(15,23,42,0.95)";
  ctx.fillRect(gx,gy,barW,barH);

  ctx.fillStyle = gauge>=100 ? "#facc15" : "#38bdf8";
  ctx.fillRect(gx,gy,barW*(gauge/100),barH);

  ctx.strokeStyle="#0f172a";
  ctx.strokeRect(gx,gy,barW,barH);

  ctx.fillStyle="#e5e7eb";
  ctx.font="11px system-ui";
  ctx.textAlign="left";
  ctx.fillText("ULT", gx, gy-4);
  if(gauge>=100){
    ctx.fillStyle="#facc15";
    ctx.fillText("READY!", gx+barW+10, gy+barH-1);
  }
  ctx.restore();
}

/* ===== é€±é–“ãƒ™ã‚¹ãƒˆ & ãƒ­ãƒ¼ã‚«ãƒ«TOP10 ===== */
function getWeekId(){
  const d=new Date();
  const one=new Date(d.getFullYear(),0,1);
  const week=Math.ceil(((d-one)/86400000+one.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}
function updateWeeklyBest(rank){
  const weekId = getWeekId();
  let data = JSON.parse(localStorage.getItem(WEEK_KEY) || "null");
  if(!data || data.weekId !== weekId){
    data = {weekId,bestRank:rank,bestKills:player.kills,bestZone:player.zoneScore};
  }else{
    data.bestRank = Math.min(data.bestRank,rank);
    data.bestKills = Math.max(data.bestKills,player.kills);
    data.bestZone = Math.max(data.bestZone,player.zoneScore);
  }
  localStorage.setItem(WEEK_KEY, JSON.stringify(data));
  renderWeeklyHUD(data);
}
function loadWeeklyHUD(){
  const data = JSON.parse(localStorage.getItem(WEEK_KEY) || "null");
  if(data) renderWeeklyHUD(data);
  else weeklyHUD.textContent = "";
}
function renderWeeklyHUD(data){
  const t = i18n[lang];
  weeklyHUD.textContent =
    `${t.weeklyTitle}\n`+
    `Rank: ${data.bestRank}  K: ${data.bestKills}  Z: ${data.bestZone.toFixed(0)}`;
}
function updateLocalRanking(){
  let arr = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");
  const total = player.kills + player.zoneScore;
  arr.push({
    name: player.name,
    kills: player.kills,
    zone: player.zoneScore,
    total: total
  });
  arr.sort((a,b)=> b.total - a.total);
  arr = arr.slice(0,10);
  localStorage.setItem(LOCAL_KEY, JSON.stringify(arr));
}
function showLocalRanking(){
  const arr = JSON.parse(localStorage.getItem(LOCAL_KEY) || "[]");
  localTableBody.innerHTML = "";
  arr.forEach((r,i)=>{
    const total = (typeof r.total === "number" ? r.total : (r.kills + r.zone));
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.kills}</td><td>${r.zone.toFixed(0)}</td><td>${total.toFixed(0)}</td>`;
    localTableBody.appendChild(tr);
  });
  localOverlay.style.display="flex";
}

/* ===== ãƒªã‚¶ãƒ«ãƒˆ ===== */
function showResult(){
  const ranking = units.map(u=>{
    const total = u.kills + u.zoneScore;
    return {
      name: u.name,
      kills: u.kills,
      zone: u.zoneScore,
      total: total,
      isPlayer: u===player
    };
  }).sort((a,b)=> (b.total - a.total) || (b.kills - a.kills) || (b.zone - a.zone));

  const playerIndex = ranking.findIndex(r=>r.isPlayer);
  const rank = playerIndex + 1;

  resultTableBody.innerHTML = "";
  ranking.forEach((r,i)=>{
    const tr = document.createElement("tr");
    if(r.isPlayer) tr.classList.add("you");
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.kills}</td><td>${r.zone.toFixed(0)}</td><td>${r.total.toFixed(0)}</td>`;
    resultTableBody.appendChild(tr);
  });

  const t = i18n[lang];
  resultSummary.textContent = `${t.resultYourRank}: ${rank}`;

  shareText.value = t.shareTemplate
    .replace("{name}", player.name)
    .replace("{rank}", rank)
    .replace("{kills}", player.kills)
    .replace("{zone}", player.zoneScore.toFixed(0));

  updateWeeklyBest(rank);
  updateLocalRanking();

  resultOverlay.style.display = "flex";
}

/* ===== çµæœç”»åƒä¿å­˜ ===== */
function saveResultImage(){
  const ow=800, oh=600;
  const imgCanvas = document.createElement("canvas");
  imgCanvas.width=ow; imgCanvas.height=oh;
  const g = imgCanvas.getContext("2d");

  g.fillStyle="#020617";
  g.fillRect(0,0,ow,oh);

  g.fillStyle="#f9fafb";
  g.font="24px system-ui";
  g.fillText("Sky Magic Dogfight",20,40);
  g.font="13px system-ui";
  g.fillText(new Date().toLocaleString(),20,62);

  g.font="15px system-ui";
  g.fillText("Rank  Name           K   Zone  Total",20,100);
  g.font="13px system-ui";

  const rows = Array.from(resultTableBody.children);
  let y=130;
  rows.forEach(row=>{
    const tds = row.children;
    const rank = tds[0].textContent;
    const name = tds[1].textContent;
    const k    = tds[2].textContent;
    const z    = tds[3].textContent;
    const total= tds[4] ? tds[4].textContent : String(Number(k)+Number(z));
    if(row.classList.contains("you")) g.fillStyle="#f97316";
    else g.fillStyle="#e5e7eb";
    const kStr = k.padEnd(4);
    const zStr = z.padEnd(6);
    g.fillText(
      `${rank.padEnd(4)} ${name.padEnd(12)} ${kStr} ${zStr} ${total}`,
      20,y
    );
    y+=22;
  });

  g.fillStyle="#e5e7eb";
  g.fillText(
    `You: ${player.name}`,
    20, oh-40
  );

  const a=document.createElement("a");
  a.href=imgCanvas.toDataURL("image/png");
  a.download="sky_magic_result.png";
  a.click();
}

/* åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— */
autoInputMode();
applyLanguage();
loadWeeklyHUD();
setupStickEvents();
resizeGame();
</script>

</body>
</html>
